var e=(e,l,t)=>new Promise(((o,a)=>{var s=e=>{try{n(t.next(e))}catch(l){a(l)}},d=e=>{try{n(t.throw(e))}catch(l){a(l)}},n=e=>e.done?o(e.value):Promise.resolve(e.value).then(s,d);n((t=t.apply(e,l)).next())}));import{_ as l,c as t,o,a,i as s,b as d,d as n,w as r,q as i,f as c,F as u,h as m,t as b,n as v,E as h,r as p,l as g,G as y,m as f,M}from"./index-DvBYsyF5.js";const w={class:"container-fluid py-3"},_={class:"card"},E={class:"card-body border-bottom"},k={class:"col-md-3"},x={class:"col-md-3"},F={class:"col-md-3"},C={class:"card-body"},H={class:"table-responsive","data-testid":"holder-table-container"},I={class:"table table-bordered table-hover"},$=["data-testid"],L=["data-testid"],U=["onClick","data-testid"],D=["onClick","disabled","data-testid"],S={key:0},T={key:0,class:"card-body text-center py-5 position-absolute top-0 start-0 w-100 h-100 bg-white bg-opacity-75","data-testid":"loading-indicator"},V={class:"modal fade",id:"holderModal",tabindex:"-1","aria-hidden":"true","data-testid":"holder-modal"},B={class:"modal-dialog"},O={class:"modal-content"},P={class:"modal-header"},q={class:"modal-title","data-testid":"modal-title"},A={class:"modal-body"},j={class:"mb-3"},G={class:"mb-3"},J={class:"mb-3"},N=["value"],R={class:"mb-3"},z={class:"text-end"},K=["disabled"],Q={class:"modal fade",id:"deleteModal",tabindex:"-1","aria-hidden":"true","data-testid":"delete-modal"},W={class:"modal-dialog"},X={class:"modal-content"},Y={class:"modal-body"},Z={"data-testid":"delete-confirmation-message"},ee={class:"modal-footer"},le=["disabled"];const te=l({__name:"Holder",setup(l,{expose:t}){t();const o=h(),a=p([]),s=p([]),d=p(!1),n=p(!1),r=p(!1),i=p(!1),c=p(null);let u=null,m=null;const b=p({name:"",type:"",status:""}),v=p({name:"",type:"individual",user_id:"",status:1}),w=()=>{console.log("开始初始化模态框...");try{const e=document.getElementById("holderModal"),l=document.getElementById("deleteModal");if(e){const l=bootstrap.Modal.getInstance(e);l&&(l.dispose(),console.log("销毁已存在的持有人模态框实例")),u=new bootstrap.Modal(e,{backdrop:"static",keyboard:!1}),console.log("持有人模态框初始化成功")}else console.error("未找到持有人模态框元素");if(l){const e=bootstrap.Modal.getInstance(l);e&&(e.dispose(),console.log("销毁已存在的删除确认模态框实例")),m=new bootstrap.Modal(l,{backdrop:"static",keyboard:!1}),console.log("删除确认模态框初始化成功")}else console.error("未找到删除确认模态框元素");console.log("模态框初始化完成")}catch(e){console.error("初始化模态框时出错:",e)}},_=()=>{document.querySelectorAll(".modal-backdrop").forEach((e=>{e.classList.remove("show"),setTimeout((()=>{e.remove()}),150)})),document.body.classList.remove("modal-open"),document.body.style.overflow="",document.body.style.paddingRight=""},E=()=>e(this,null,(function*(){console.log("开始加载持有人列表..."),d.value=!0;try{console.log("发送GET请求到 /api/holders");const e=yield f.get("/api/holders");console.log("获取持有人列表响应:",e.data),e.data.success?(a.value=e.data.data,console.log(`成功加载 ${a.value.length} 个持有人`),a.value.forEach((e=>{console.log(`持有人ID: ${e.id}, 姓名: ${e.name}, 用户名: ${e.username}, 显示名称: ${e.user_display_name}`)}))):(console.error("加载持有人列表失败:",e.data.message),o.error("加载持有人列表失败: "+e.data.message))}catch(e){console.error("加载持有人列表失败:",e),o.error("加载持有人列表失败，请稍后重试")}finally{d.value=!1,console.log("持有人列表加载完成")}})),k=()=>e(this,null,(function*(){try{console.log("开始加载可用用户列表...");const e=yield f.get("/api/system/user/available");console.log("获取可用用户列表响应:",e.data),e.data.success?(s.value=e.data.data,console.log(`成功加载 ${s.value.length} 个可用用户`),s.value.forEach((e=>{console.log(`用户ID: ${e.id}, 用户名: ${e.username}, 显示名称: ${e.display_name}`)}))):console.error("加载可用用户列表失败:",e.data.message)}catch(e){console.error("加载可用用户列表失败:",e),o.error("加载可用用户列表失败，请稍后重试")}})),x=()=>{console.log("重新初始化模态框"),w()};g((()=>{E(),k(),setTimeout((()=>{w(),console.log("模态框初始化完成")}),500),window.addEventListener("load",x),document.addEventListener("DOMContentLoaded",x);const e=document.getElementById("holderModal");e&&e.addEventListener("hidden.bs.modal",(()=>{console.log("持有人模态框隐藏事件触发"),_()}));const l=document.getElementById("deleteModal");l&&l.addEventListener("hidden.bs.modal",(()=>{console.log("删除确认模态框隐藏事件触发"),_()}))})),y((()=>{window.removeEventListener("load",x),document.removeEventListener("DOMContentLoaded",x);const e=document.getElementById("holderModal");e&&e.removeEventListener("hidden.bs.modal",_);const l=document.getElementById("deleteModal");l&&l.removeEventListener("hidden.bs.modal",_)}));const F=()=>{console.log("关闭持有人模态框"),u?(u.hide(),console.log("持有人模态框已隐藏"),_()):console.error("持有人模态框实例不存在")},C=()=>{console.log("关闭删除确认模态框"),m?(m.hide(),console.log("删除确认模态框已隐藏"),_()):console.error("删除确认模态框实例不存在")},H={toast:o,holders:a,availableUsers:s,loading:d,saving:n,deleting:r,isEdit:i,currentHolder:c,get holderModal(){return u},set holderModal(e){u=e},get deleteModal(){return m},set deleteModal(e){m=e},searchForm:b,holderForm:v,initModals:w,cleanupModalEffects:_,loadHolders:E,loadAvailableUsers:k,resetSearch:()=>{b.value={name:"",type:"",status:""},E()},openAddModal:()=>{console.log("打开添加持有人模态框"),i.value=!1,v.value={name:"",type:"individual",user_id:"",status:1},u?(u.show(),console.log("模态框已显示")):(console.error("模态框实例不存在"),w(),setTimeout((()=>{u?(u.show(),console.log("重新初始化后模态框已显示")):(console.error("重新初始化后模态框实例仍不存在"),o.error("打开模态框失败，请刷新页面重试"))}),100))},openEditModal:e=>{if(console.log("准备编辑持有人",e),i.value=!0,v.value={id:e.id,name:e.name,type:e.type,user_id:e.user_id||"",status:e.status},e.user_id&&e.username){s.value.some((l=>l.id===e.user_id))||s.value.push({id:e.user_id,username:e.username,display_name:e.user_display_name})}u?(u.show(),console.log("编辑模态框已显示")):(console.error("编辑模态框实例不存在"),w(),setTimeout((()=>{u?(u.show(),console.log("重新初始化后编辑模态框已显示")):(console.error("重新初始化后编辑模态框实例仍不存在"),o.error("打开编辑模态框失败，请刷新页面重试"))}),100))},saveHolder:()=>e(this,null,(function*(){var e,l,t;if(v.value.name){n.value=!0;try{let e;console.log("准备保存持有人数据:",JSON.stringify(v.value)),i.value?(console.log(`发送PUT请求到 /api/holders/${v.value.id}`),e=yield f.put(`/api/holders/${v.value.id}`,v.value)):(console.log("发送POST请求到 /api/holders"),e=yield f.post("/api/holders",v.value)),console.log("服务器响应:",e.data),e.data.success?(o.success(e.data.message||(i.value?"更新持有人成功":"添加持有人成功")),F(),E()):o.error(e.data.message||"操作失败")}catch(a){console.error("保存持有人失败:",a),console.error("错误详情:",(null==(e=a.response)?void 0:e.data)||"无详细信息"),o.error((null==(t=null==(l=a.response)?void 0:l.data)?void 0:t.message)||"保存失败，请稍后重试")}finally{n.value=!1}}else o.warning("请输入持有人姓名")})),confirmDelete:e=>{console.log("准备删除持有人",e),c.value=e,m?(m.show(),console.log("删除确认模态框已显示")):(console.error("删除确认模态框实例不存在"),w(),setTimeout((()=>{m?(m.show(),console.log("重新初始化后删除确认模态框已显示")):(console.error("重新初始化后删除确认模态框实例仍不存在"),o.error("打开删除确认模态框失败，请刷新页面重试"))}),100))},deleteHolder:()=>e(this,null,(function*(){var e,l,t;if(c.value){r.value=!0;try{console.log(`准备删除持有人ID: ${c.value.id}`);const e=yield f.delete(`/api/holders/${c.value.id}`);console.log("服务器响应:",e.data),e.data.success?(o.success(e.data.message||"删除持有人成功"),C(),E()):o.error(e.data.message||"删除失败")}catch(a){console.error("删除持有人失败:",a),console.error("错误详情:",(null==(e=a.response)?void 0:e.data)||"无详细信息"),o.error((null==(t=null==(l=a.response)?void 0:l.data)?void 0:t.message)||"删除失败，请稍后重试")}finally{r.value=!1}}})),reinitModals:x,closeHolderModal:F,closeDeleteModal:C,ref:p,onMounted:g,onUnmounted:y,get useToast(){return h},get axios(){return f},get Modal(){return M}};return Object.defineProperty(H,"__isScriptSetup",{enumerable:!1,value:!0}),H}},[["render",function(e,l,h,p,g,y){var f;return o(),t("div",w,[a("div",_,[a("div",{class:"card-header d-flex justify-content-between align-items-center"},[l[8]||(l[8]=a("h4",{class:"mb-0","data-testid":"holder-title"},"持有人管理",-1)),a("button",{class:"btn btn-primary",onClick:p.openAddModal,"data-testid":"add-holder-btn"},l[7]||(l[7]=[a("i",{class:"bi bi-plus-circle"},null,-1),d(" 添加持有人 ")]))]),a("div",E,[a("form",{onSubmit:n(p.loadHolders,["prevent"]),class:"row g-3 align-items-end","data-testid":"search-form"},[a("div",k,[l[9]||(l[9]=a("label",{class:"form-label","data-testid":"holder-name-label"},"持有人姓名",-1)),r(a("input",{type:"text",class:"form-control","onUpdate:modelValue":l[0]||(l[0]=e=>p.searchForm.name=e),placeholder:"输入持有人姓名","data-testid":"holder-name-input"},null,512),[[i,p.searchForm.name]])]),a("div",x,[l[11]||(l[11]=a("label",{class:"form-label","data-testid":"holder-type-label"},"类型",-1)),r(a("select",{class:"form-select","onUpdate:modelValue":l[1]||(l[1]=e=>p.searchForm.type=e),"data-testid":"holder-type-select"},l[10]||(l[10]=[a("option",{value:""},"全部",-1),a("option",{value:"individual"},"个人",-1),a("option",{value:"institution"},"机构",-1)]),512),[[c,p.searchForm.type]])]),a("div",F,[l[13]||(l[13]=a("label",{class:"form-label","data-testid":"holder-status-label"},"状态",-1)),r(a("select",{class:"form-select","onUpdate:modelValue":l[2]||(l[2]=e=>p.searchForm.status=e),"data-testid":"holder-status-select"},l[12]||(l[12]=[a("option",{value:""},"全部",-1),a("option",{value:"1"},"启用",-1),a("option",{value:"0"},"禁用",-1)]),512),[[c,p.searchForm.status]])]),a("div",{class:"col-md-3"},[l[15]||(l[15]=a("button",{class:"btn btn-primary me-2",type:"submit","data-testid":"search-btn"},[a("i",{class:"bi bi-search"}),d(" 查询 ")],-1)),a("button",{class:"btn btn-secondary",type:"button",onClick:p.resetSearch,"data-testid":"reset-btn"},l[14]||(l[14]=[a("i",{class:"bi bi-arrow-counterclockwise"},null,-1),d(" 重置 ")]))])],32)]),a("div",C,[a("div",H,[a("table",I,[l[17]||(l[17]=a("thead",null,[a("tr",null,[a("th",{style:{width:"60px"}},"ID"),a("th",null,"持有人姓名"),a("th",null,"类型"),a("th",null,"关联用户"),a("th",null,"状态"),a("th",null,"创建时间"),a("th",null,"更新时间"),a("th",{style:{width:"150px"}},"操作")])],-1)),a("tbody",null,[(o(!0),t(u,null,m(p.holders,(e=>(o(),t("tr",{key:e.id,"data-testid":"holder-row-"+e.id},[a("td",null,b(e.id),1),a("td",null,b(e.name),1),a("td",null,b("individual"===e.type?"个人":"机构"),1),a("td",null,b(e.username||"未关联"),1),a("td",null,[a("span",{class:v(1===e.status?"badge bg-success":"badge bg-danger"),"data-testid":"holder-status-badge-"+e.id},b(1===e.status?"启用":"禁用"),11,L)]),a("td",null,b(e.created_at),1),a("td",null,b(e.updated_at),1),a("td",null,[a("button",{class:"btn btn-sm btn-info me-1",onClick:l=>p.openEditModal(e),"data-testid":"edit-holder-btn-"+e.id}," 编辑 ",8,U),a("button",{class:"btn btn-sm btn-danger",onClick:l=>p.confirmDelete(e),disabled:p.loading,"data-testid":"delete-holder-btn-"+e.id}," 删除 ",8,D)])],8,$)))),128)),0===p.holders.length?(o(),t("tr",S,l[16]||(l[16]=[a("td",{colspan:"8",class:"text-center py-3","data-testid":"no-data-message"},"暂无数据",-1)]))):s("",!0)])])])]),p.loading?(o(),t("div",T,l[18]||(l[18]=[a("div",{class:"spinner-border text-primary",role:"status"},[a("span",{class:"visually-hidden"},"加载中...")],-1),a("p",{class:"mt-2"},"加载数据中，请稍候...",-1)]))):s("",!0)]),a("div",V,[a("div",B,[a("div",O,[a("div",P,[a("h5",q,b(p.isEdit?"编辑持有人":"添加持有人"),1),a("button",{type:"button",class:"btn-close",onClick:p.closeHolderModal,"aria-label":"Close","data-testid":"close-modal-btn"})]),a("div",A,[a("form",{onSubmit:n(p.saveHolder,["prevent"]),"data-testid":"holder-form"},[a("div",j,[l[19]||(l[19]=a("label",{class:"form-label","data-testid":"holder-name-form-label"},[d("持有人姓名 "),a("span",{class:"text-danger"},"*")],-1)),r(a("input",{type:"text",class:"form-control","onUpdate:modelValue":l[3]||(l[3]=e=>p.holderForm.name=e),required:"",placeholder:"请输入持有人姓名","data-testid":"holder-name-form-input",id:"holder-name"},null,512),[[i,p.holderForm.name]])]),a("div",G,[l[21]||(l[21]=a("label",{class:"form-label","data-testid":"holder-type-form-label"},[d("类型 "),a("span",{class:"text-danger"},"*")],-1)),r(a("select",{class:"form-select","onUpdate:modelValue":l[4]||(l[4]=e=>p.holderForm.type=e),required:"","data-testid":"holder-type-form-select",id:"holder-type"},l[20]||(l[20]=[a("option",{value:"individual"},"个人",-1),a("option",{value:"institution"},"机构",-1)]),512),[[c,p.holderForm.type]])]),a("div",J,[l[23]||(l[23]=a("label",{class:"form-label","data-testid":"holder-user-form-label"},"关联用户",-1)),r(a("select",{class:"form-select","onUpdate:modelValue":l[5]||(l[5]=e=>p.holderForm.user_id=e),"data-testid":"holder-user-form-select",id:"holder-user"},[l[22]||(l[22]=a("option",{value:""},"不关联用户",-1)),(o(!0),t(u,null,m(p.availableUsers,(e=>(o(),t("option",{key:e.id,value:e.id},b(e.username),9,N)))),128))],512),[[c,p.holderForm.user_id]])]),a("div",R,[l[25]||(l[25]=a("label",{class:"form-label","data-testid":"holder-status-form-label"},"状态",-1)),r(a("select",{class:"form-select","onUpdate:modelValue":l[6]||(l[6]=e=>p.holderForm.status=e),"data-testid":"holder-status-form-select",id:"holder-status"},l[24]||(l[24]=[a("option",{value:1},"启用",-1),a("option",{value:0},"禁用",-1)]),512),[[c,p.holderForm.status]])]),a("div",z,[a("button",{type:"button",class:"btn btn-secondary me-2",onClick:p.closeHolderModal,"data-testid":"cancel-form-btn"}," 取消 "),a("button",{type:"submit",class:"btn btn-primary",disabled:p.saving,"data-testid":"save-holder-btn"},b(p.saving?"保存中...":"保存"),9,K)])],32)])])])]),a("div",Q,[a("div",W,[a("div",X,[a("div",{class:"modal-header"},[l[26]||(l[26]=a("h5",{class:"modal-title","data-testid":"delete-modal-title"},"确认删除",-1)),a("button",{type:"button",class:"btn-close",onClick:p.closeDeleteModal,"aria-label":"Close","data-testid":"close-delete-modal-btn"})]),a("div",Y,[a("p",Z,[l[27]||(l[27]=d("确定要删除持有人 ")),a("strong",null,b(null==(f=p.currentHolder)?void 0:f.name),1),l[28]||(l[28]=d(" 吗？"))]),l[29]||(l[29]=a("p",{class:"text-danger","data-testid":"delete-warning"},"注意：如果该持有人已被交易记录引用，将只会被禁用而非删除。",-1))]),a("div",ee,[a("button",{type:"button",class:"btn btn-secondary",onClick:p.closeDeleteModal,"data-testid":"cancel-delete-btn"},"取消"),a("button",{type:"button",class:"btn btn-danger",onClick:p.deleteHolder,disabled:p.deleting,"data-testid":"confirm-delete-btn"},b(p.deleting?"删除中...":"确认删除"),9,le)])])])])])}],["__scopeId","data-v-87703f69"],["__file","Holder.vue"]]);export{te as default};
