var t=(t,e,a)=>new Promise(((s,o)=>{var n=t=>{try{l(a.next(t))}catch(e){o(e)}},r=t=>{try{l(a.throw(t))}catch(e){o(e)}},l=t=>t.done?s(t.value):Promise.resolve(t.value).then(n,r);l((a=a.apply(t,e)).next())}));import{_ as e,c as a,o as s,a as o,d as n,w as r,q as l,n as d,t as i,f as c,F as u,h as p,i as m,b,u as v,B as _,r as f,s as y,l as k,m as g}from"./index-DTKJt6HL.js";const h={class:"card","data-testid":"transaction-edit-container"},w={class:"card-header d-flex justify-content-between align-items-center"},q={class:"card-body"},x={class:"row mb-4"},F={class:"col-md-3"},U={class:"invalid-feedback","data-testid":"transaction-date-error"},V={class:"col-md-3"},C={class:"invalid-feedback","data-testid":"stock-code-error"},E={class:"col-md-3"},$={class:"invalid-feedback","data-testid":"transaction-code-error"},T={class:"col-md-3"},j={class:"invalid-feedback","data-testid":"transaction-type-error"},D={class:"mb-4"},L={class:"border rounded p-3","data-testid":"transaction-details-container"},A=["data-testid"],I={class:"col-md-5"},P=["data-testid"],S=["onUpdate:modelValue","data-testid"],B={class:"col-md-5"},M=["data-testid"],N=["onUpdate:modelValue","data-testid"],R=["data-testid"],z={class:"col-md-2 d-flex align-items-end"},H=["onClick","disabled","data-testid"],O={class:"mb-4"},G={class:"border rounded p-3","data-testid":"fees-container"},J={class:"row g-3"},K={class:"col-md-4"},Q={class:"col-md-4"},W={class:"col-md-4"},X={class:"col-md-4"},Y={class:"col-md-4"},Z={class:"d-flex justify-content-center gap-2"},tt=["disabled"],et={key:0,class:"spinner-border spinner-border-sm me-1"};const at=e({__name:"TransactionEdit",setup(e,{expose:a}){a();const s=v(),o=_(),n=f(!1),r=f({}),l=f({transaction_date:"",stock_code:"",stock_name:"",transaction_code:"",transaction_type:"",details:[{quantity:null,price:null}],broker_fee:0,transaction_levy:0,stamp_duty:0,trading_fee:0,deposit_fee:0,market:"",prev_quantity:0,prev_cost:0,prev_avg_cost:0,current_quantity:0,current_cost:0,current_avg_cost:0}),d=()=>t(this,null,(function*(){try{const t=yield g.get(`/api/stock/transactions/${o.params.id}`);if(!t.data.success)throw new Error(t.data.message||"加载交易记录失败");const e=t.data.data;if(!e)throw new Error("交易记录不存在");l.value={transaction_date:e.transaction_date,stock_code:e.stock_code,stock_name:e.stock_name,transaction_code:e.transaction_code,transaction_type:e.transaction_type.toLowerCase(),details:e.details&&e.details.length>0?e.details:[{quantity:e.total_quantity,price:e.total_amount/e.total_quantity}],broker_fee:e.broker_fee||0,transaction_levy:e.transaction_levy||0,stamp_duty:e.stamp_duty||0,trading_fee:e.trading_fee||0,deposit_fee:e.deposit_fee||0,market:e.market,prev_quantity:e.prev_quantity||0,prev_cost:e.prev_cost||0,prev_avg_cost:e.prev_avg_cost||0,current_quantity:e.current_quantity||0,current_cost:e.current_cost||0,current_avg_cost:e.current_avg_cost||0}}catch(t){throw c(t.message||"加载交易记录失败，请稍后重试","danger"),t}})),i=()=>{try{r.value={};let t=!0;return l.value.details.forEach(((e,a)=>{(!e.price||e.price<=0)&&(r.value[`price_${a}`]="请输入有效的价格",t=!1)})),t}catch(t){return!1}},c=(t,e="danger")=>{const a=document.getElementById("toast-container")||(()=>{const t=document.createElement("div");return t.id="toast-container",t.className="position-fixed top-0 end-0 p-3",t.style.zIndex="1050",document.body.appendChild(t),t})(),s=document.createElement("div");s.className=`toast align-items-center text-white bg-${e} border-0`,s.setAttribute("role","alert"),s.setAttribute("aria-live","assertive"),s.setAttribute("aria-atomic","true"),s.innerHTML=`\n    <div class="d-flex">\n      <div class="toast-body">\n        ${t}\n      </div>\n      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>\n    </div>\n  `,a.appendChild(s);new bootstrap.Toast(s).show(),s.addEventListener("hidden.bs.toast",(()=>{s.remove()}))};y((()=>l.value.transaction_type),(t=>{"buy"===t&&(l.value.stamp_duty=0)})),k((()=>t(this,null,(function*(){try{yield d()}catch(t){c("加载交易记录失败，请稍后重试","danger")}}))));const u={router:s,route:o,submitting:n,errors:r,form:l,loadTransaction:d,validateForm:i,submitForm:()=>t(this,null,(function*(){var t,e,a;try{if(!i()||n.value)return;n.value=!0;const t=l.value.details.reduce(((t,e)=>t+(parseFloat(e.quantity)||0)),0),e=l.value.details.reduce(((t,e)=>t+(parseFloat(e.quantity)||0)*(parseFloat(e.price)||0)),0);console.log("提交交易数据:",{"总数量":t,"总金额":e,"明细":l.value.details});const a={transaction_date:l.value.transaction_date,stock_code:l.value.stock_code,transaction_code:l.value.transaction_code,transaction_type:l.value.transaction_type.toLowerCase(),details:l.value.details.map((t=>({quantity:parseFloat(t.quantity)||0,price:parseFloat(t.price)||0}))),total_quantity:t,total_amount:e,broker_fee:parseFloat(l.value.broker_fee)||0,transaction_levy:parseFloat(l.value.transaction_levy)||0,stamp_duty:parseFloat(l.value.stamp_duty)||0,trading_fee:parseFloat(l.value.trading_fee)||0,deposit_fee:parseFloat(l.value.deposit_fee)||0,market:l.value.market},r=yield g.put(`/api/stock/transactions/${o.params.id}`,a);if(!r.data.success)throw new Error(r.data.message||"操作失败");c("交易记录更新成功","success"),s.back()}catch(r){c((null==(e=null==(t=r.response)?void 0:t.data)?void 0:e.message)||r.message||"更新失败，请稍后重试","danger"),console.error("更新交易记录失败:",(null==(a=r.response)?void 0:a.data)||r)}finally{n.value=!1}})),addDetail:()=>{l.value.details.push({quantity:null,price:null})},removeDetail:t=>{l.value.details.length>1&&l.value.details.splice(t,1)},showToast:c,ref:f,onMounted:k,watch:y,get useRouter(){return v},get useRoute(){return _},get axios(){return g}};return Object.defineProperty(u,"__isScriptSetup",{enumerable:!1,value:!0}),u}},[["render",function(t,e,v,_,f,y){return s(),a("div",h,[o("div",w,[e[11]||(e[11]=o("h5",{class:"mb-0","data-testid":"transaction-edit-title"},"编辑交易记录",-1)),o("button",{class:"btn btn-outline-secondary btn-sm",onClick:e[0]||(e[0]=e=>t.$router.back())}," 返回列表 ")]),o("div",q,[o("form",{onSubmit:n(_.submitForm,["prevent"])},[o("div",x,[o("div",F,[e[12]||(e[12]=o("label",{class:"form-label","data-testid":"transaction-date-label"},"交易日期",-1)),r(o("input",{type:"date",class:d(["form-control",{"is-invalid":_.errors.transaction_date}]),"onUpdate:modelValue":e[1]||(e[1]=t=>_.form.transaction_date=t),readonly:"",disabled:"","data-testid":"transaction-date-input"},null,2),[[l,_.form.transaction_date]]),o("div",U,i(_.errors.transaction_date),1)]),o("div",V,[e[13]||(e[13]=o("label",{class:"form-label","data-testid":"stock-code-label"},"股票代码",-1)),r(o("input",{type:"text",class:d(["form-control",{"is-invalid":_.errors.stock_code}]),"onUpdate:modelValue":e[2]||(e[2]=t=>_.form.stock_code=t),readonly:"",disabled:"","data-testid":"stock-code-input"},null,2),[[l,_.form.stock_code]]),o("div",C,i(_.errors.stock_code),1)]),o("div",E,[e[14]||(e[14]=o("label",{class:"form-label","data-testid":"transaction-code-label"},"交易编号",-1)),r(o("input",{type:"text",class:d(["form-control",{"is-invalid":_.errors.transaction_code}]),"onUpdate:modelValue":e[3]||(e[3]=t=>_.form.transaction_code=t),readonly:"",disabled:"","data-testid":"transaction-code-input"},null,2),[[l,_.form.transaction_code]]),o("div",$,i(_.errors.transaction_code),1)]),o("div",T,[e[16]||(e[16]=o("label",{class:"form-label","data-testid":"transaction-type-label"},"买卖",-1)),r(o("select",{class:d(["form-select",{"is-invalid":_.errors.transaction_type}]),"onUpdate:modelValue":e[4]||(e[4]=t=>_.form.transaction_type=t),disabled:"","data-testid":"transaction-type-input"},e[15]||(e[15]=[o("option",{value:"buy"},"买入",-1),o("option",{value:"sell"},"卖出",-1)]),2),[[c,_.form.transaction_type]]),o("div",j,i(_.errors.transaction_type),1)])]),o("div",D,[o("div",{class:"d-flex justify-content-between align-items-center mb-2"},[e[17]||(e[17]=o("label",{class:"form-label mb-0","data-testid":"transaction-details-label"},"成交明细",-1)),o("button",{type:"button",class:"btn btn-sm btn-outline-primary",onClick:_.addDetail,"data-testid":"add-detail-btn"}," 添加成交记录 ")]),o("div",L,[(s(!0),a(u,null,p(_.form.details,((t,e)=>(s(),a("div",{key:e,class:"row g-2 mb-2","data-testid":"detail-row-"+e},[o("div",I,[o("label",{class:"form-label","data-testid":"quantity-label-"+e},"数量",8,P),r(o("input",{type:"number",class:"form-control","onUpdate:modelValue":e=>t.quantity=e,"data-testid":"quantity-input-"+e},null,8,S),[[l,t.quantity]])]),o("div",B,[o("label",{class:"form-label","data-testid":"price-label-"+e},"价格",8,M),r(o("input",{type:"number",class:d(["form-control",{"is-invalid":_.errors[`price_${e}`]}]),"onUpdate:modelValue":e=>t.price=e,step:"0.001","data-testid":"price-input-"+e},null,10,N),[[l,t.price]]),o("div",{class:"invalid-feedback","data-testid":"price-error-"+e},i(_.errors[`price_${e}`]),9,R)]),o("div",z,[o("button",{type:"button",class:"btn btn-outline-danger w-100",onClick:t=>_.removeDetail(e),disabled:1===_.form.details.length,"data-testid":"remove-detail-btn-"+e}," 删除 ",8,H)])],8,A)))),128))])]),o("div",O,[e[23]||(e[23]=o("label",{class:"form-label","data-testid":"fees-label"},"费用明细",-1)),o("div",G,[o("div",J,[o("div",K,[e[18]||(e[18]=o("label",{class:"form-label","data-testid":"broker-fee-label"},"经纪佣金",-1)),r(o("input",{type:"number",class:"form-control","onUpdate:modelValue":e[5]||(e[5]=t=>_.form.broker_fee=t),step:"0.01","data-testid":"broker-fee-input"},null,512),[[l,_.form.broker_fee]])]),o("div",Q,[e[19]||(e[19]=o("label",{class:"form-label","data-testid":"transaction-levy-label"},"交易征费",-1)),r(o("input",{type:"number",class:"form-control","onUpdate:modelValue":e[6]||(e[6]=t=>_.form.transaction_levy=t),step:"0.01","data-testid":"transaction-levy-input"},null,512),[[l,_.form.transaction_levy]])]),o("div",W,[e[20]||(e[20]=o("label",{class:"form-label","data-testid":"stamp-duty-label"},"印花税",-1)),r(o("input",{type:"number",class:"form-control","onUpdate:modelValue":e[7]||(e[7]=t=>_.form.stamp_duty=t),step:"0.01","data-testid":"stamp-duty-input"},null,512),[[l,_.form.stamp_duty]])]),o("div",X,[e[21]||(e[21]=o("label",{class:"form-label","data-testid":"trading-fee-label"},"交易费",-1)),r(o("input",{type:"number",class:"form-control","onUpdate:modelValue":e[8]||(e[8]=t=>_.form.trading_fee=t),step:"0.01","data-testid":"trading-fee-input"},null,512),[[l,_.form.trading_fee]])]),o("div",Y,[e[22]||(e[22]=o("label",{class:"form-label","data-testid":"deposit-fee-label"},"存入证券费",-1)),r(o("input",{type:"number",class:"form-control","onUpdate:modelValue":e[9]||(e[9]=t=>_.form.deposit_fee=t),step:"0.01","data-testid":"deposit-fee-input"},null,512),[[l,_.form.deposit_fee]])])])])]),o("div",Z,[o("button",{type:"button",class:"btn btn-secondary",onClick:e[10]||(e[10]=e=>t.$router.back()),"data-testid":"cancel-btn"}," 取消 "),o("button",{type:"submit",class:"btn btn-primary",disabled:_.submitting,"data-testid":"save-btn"},[_.submitting?(s(),a("span",et)):m("",!0),e[24]||(e[24]=b(" 保存修改 "))],8,tt)])],32)])])}],["__scopeId","data-v-4bbcefdc"],["__file","TransactionEdit.vue"]]);export{at as default};
