# 上海华虹分单数据修复指南

本文档提供了修复上海华虹（01347）分单数据的详细步骤，解决盈利统计页面无法展开明细的问题。

## 问题描述

在盈利统计页面中，上海华虹（01347）的分单数据无法正常展开明细，点击展开后页面显示空白。

## 原因分析

经过分析，可能的原因包括：

1. 分单数据中的持有人信息不完整
2. 分单记录中的计算字段（如realized_profit、profit_rate等）缺失或计算错误
3. 存在重复的分单记录，导致数据不一致
4. 部分必要字段为NULL，影响前端渲染

## 修复方法

### 方法一：使用Python脚本在本地修复

我们提供了一个Python脚本，可以在本地连接数据库并修复上海华虹的分单数据。

#### 准备工作

1. 确保已安装Python 3.6+
2. 安装必要的依赖：
   ```bash
   pip install pymysql
   ```

#### 运行修复脚本

1. 将以下文件下载到本地：
   - `fix_huahong_local.py`：主要修复脚本
   - `run_fix.py`：运行脚本

2. 在命令行中运行：
   ```bash
   python run_fix.py --host 127.0.0.1 --port 3306 --user root --password your_password --database stock
   ```

   参数说明：
   - `--host`：数据库主机地址，默认为127.0.0.1
   - `--port`：数据库端口，默认为3306
   - `--user`：数据库用户名，默认为root
   - `--password`：数据库密码，默认为空
   - `--database`：数据库名称，默认为stock

3. 脚本会执行以下修复操作：
   - 修复分单记录中的持有人名称
   - 删除重复的分单记录
   - 修复卖出类型分单记录的realized_profit值
   - 修复profit_rate字段
   - 修复可能缺失的字段值（prev_quantity、prev_cost等）
   - 修复可能的NULL值

4. 修复过程和结果会记录在`fix_huahong.log`文件中

### 方法二：直接在数据库中执行SQL脚本

如果您更熟悉SQL，也可以直接在数据库中执行我们提供的SQL脚本。

1. 将`fix_huahong_profit_stats.sql`脚本下载到本地

2. 在MySQL客户端中执行：
   ```bash
   mysql -h 127.0.0.1 -u root -p stock < fix_huahong_profit_stats.sql
   ```

## 验证修复结果

修复完成后，请执行以下步骤验证问题是否解决：

1. 重启应用服务器，确保所有缓存被清除
2. 清除浏览器缓存
3. 重新访问盈利统计页面，测试上海华虹的分单数据是否可以正常展开明细

## 常见问题

### Q: 脚本执行报错"Access denied"
A: 请确认数据库用户名和密码是否正确，以及该用户是否有足够的权限修改数据库。

### Q: 修复后仍然无法展开明细
A: 请检查浏览器控制台是否有错误信息，可能需要重启应用服务器或清除浏览器缓存。

### Q: 如何查看修复日志？
A: 修复日志保存在`fix_huahong.log`文件中，包含详细的修复过程和结果。

## 联系支持

如果您在执行上述步骤后仍然遇到问题，请联系技术支持团队获取进一步帮助。 